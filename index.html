<!DOCTYPE html>
<html lang="en">

<head>
    <title>Map Meetup</title>
    <meta property="og:description" content="map meetup" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
    <link href="style.css" rel="stylesheet" />
</head>

<body>
    <div class="container">
        <div id="map"></div>
        <div id="splash-screen"></div>
        <div id="info-box"></div>
        <div id="location-box"></div>
        <div id="category-box"></div>
        <div id="featured"></div>
        <div id="attribution"></div>
        <div id="info-button">
            <button id="refresh-features-btn" class="pill-button">
                <i class="fas fa-chevron-up"></i> Show Info
            </button>
        </div>
    </div>

    <script>

        const geoJsonFiles = ['hicksville_corrected', 'long_beach_corrected'];
        const imgSource = 'img'
        const styleFile = 'toronto-map-meetup.json'
        const spritesFile = 'data/sprites.geojson'
        const zoomThreshold = 14

        let infoBoxOpen = false;
        let locationData;

        // Show splash screen
        const splash = document.getElementById('splash-screen');
        splash.style.display = 'flex';

        const splashContent = document.createElement('div');
        splashContent.className = 'splash-content';

        const logo = document.createElement('img');
        logo.className = 'splash-logo'
        logo.src = 'img/new.png';
        splashContent.appendChild(logo);

        const spinnerContainer = document.createElement('div');
        spinnerContainer.className = 'spinner-container';
        spinnerContainer.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';

        splashContent.appendChild(spinnerContainer);
        splash.appendChild(splashContent);

        // Load map
        const map = new maplibregl.Map({
            container: "map",
            style: styleFile,
            center: [-79.38709, 43.64909],
            //maxBounds: [ [-79.56, 43.56],[-79.27, 43.72] ],
            zoom: 16,
            minZoom: 16,
            maxZoom: 16,
            bearing: -16,
            pitch: 0,
            hash: true,
            pixelRatio: 1,
            pitchWithRotate: false,
            dragRotate: false
        });

        map.on('load', async () => {

            // Hide splash screen
            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                }, 1000); // Fade-out duration
            }, 100); // Display duration

            // Load location data
            const pointsData = {
                type: 'FeatureCollection',
                features: (await Promise.all(
                    geoJsonFiles.map(name =>
                        fetch(`data/${name}.geojson`)
                            .then(r => r.json())
                            .then(data => data.features)
                    )
                )).flat()
            };
            locationData = pointsData;

            // map.addSource('sprites', {
            //     'type': 'vector',
            //     tiles: ['http://localhost:8000/sprite-tiles/{z}/{x}/{y}.pbf']
            // });

            // map.addLayer({
            //     "id": "sprites",
            //     "source": "sprites",
            //     "source-layer": "maptoons-tiles",
            //     "type": "symbol",
            //     "layout": {
            //         "icon-size": 0.8,
            //         "symbol-placement": "point",
            //         "icon-anchor": "bottom",
            //         "icon-image": [
            //             "concat",
            //             "icon-",
            //             ["get", "icon_number"]
            //         ],
            //         "icon-allow-overlap": false
            //     },
            //     "paint": {
            //         "icon-color": "hsl(0, 0%, 100%)",
            //         "icon-opacity": [
            //             "interpolate",
            //             ["exponential", 0.5],
            //             ["zoom"],
            //             16, 0, 17, 1
            //         ]
            //     },
            //     "minzoom": 16
            // });

            map.addSource("toronto-trees", {
                type: 'vector',
				tiles: ["https://geographyclub.github.io/toronto-map/data/toronto-trees/{z}/{x}/{y}.pbf"]
            });

            function addTorontoTiles(map) {
                map.addLayer({
                    "id": "toronto-trees",
                    "source": "toronto-trees",
                    "source-layer": "toronto-trees",
                    "type": "symbol",
                    "layout": {
                        "icon-size": 0.5,
                        "symbol-placement": "point",
                        "icon-keep-upright": true,
                        "icon-allow-overlap": true,
                        "icon-ignore-placement": true,
                        "icon-anchor": "bottom",
                        "symbol-sort-key": 0,
                        "icon-image": [
                            "concat",
                            "icon-",
                            ["get", "icon_number"]
                        ]
                    },
                    "paint": {
                        "icon-color": "hsl(0, 0%, 100%)",
                        "icon-opacity": [
                        "interpolate",
                        ["linear"],
                        ["zoom"],
                        15, 0, 16, 1
                        ]
                    },
                    minZoom: 16
                });
            }
            addTorontoTiles(map);

            map.addSource('location', {
                'type': 'geojson',
                'data': locationData,
                'cluster': true,
                'clusterRadius': 20,
                'clusterMinPoints': 3,
                'clusterMaxZoom': zoomThreshold - 1
            });

            document.getElementById('refresh-features-btn').addEventListener('click', () => {
                const btn = document.getElementById('refresh-features-btn');
                const infoBox = document.getElementById('info-box');

                if (infoBoxOpen) {
                    // Close the info box
                    infoBox.classList.remove('visible');
                    btn.innerHTML = '<i class="fas fa-chevron-up"></i> Show Info';
                    infoBoxOpen = false;
                } else {
                    // Open/refresh the info box
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
                    updateInfoBox().then(() => {
                        btn.innerHTML = '<i class="fas fa-chevron-down"></i> Hide Info';
                        infoBoxOpen = true;
                    });
                }
            });

            // Handle clicks on marker layer
            document.addEventListener('click', (e) => {
                // Check if clicking a marker image container
                const clickedElement = e.target.closest(
                    '.custom-marker-img-container, .custom-vehicle-img-container'
                );
                const parentMarker = clickedElement?.closest('.custom-marker');

                // Check if clicking the info box or its children
                const clickedInfoBox = e.target.closest('#info-box');

                // Check if clicking anywhere EXCEPT markers
                if (!parentMarker && !clickedInfoBox) {
                    // Remove active class from all markers
                    document.querySelectorAll('.custom-marker.active').forEach(el => {
                        el.classList.remove('active');
                    });
                    return;
                }

                // If clicking on info box, do nothing
                if (clickedInfoBox) {
                    return;
                }

                // Toggle active state on clicked marker
                parentMarker.classList.toggle('active');
                setTimeout(() => parentMarker.classList.remove('active'), 1500);

                // Handle feature data
                const featureElement = clickedElement.closest('[data-feature]');
                if (featureElement) {
                    try {
                        const feature = JSON.parse(featureElement.dataset.feature);
                        clickFeature(feature);
                    } catch (error) {
                        console.error("Couldn't parse feature data:", error);
                    }
                }
            });
            // Close infobox on click
            setupInfoBoxAutoClose();

            // Show info button
            map.once('idle', () => {
                const btn = document.getElementById('refresh-features-btn');
                btn.style.display = 'block';
            });

        });

        // Create and update markers
        const markers = {};
        let markersOnScreen = {};

        const updateMarkers = () => {
            const zoom = map.getZoom();

            if (zoom <= zoomThreshold) {
                // Remove all markers if zoomed out
                for (const id in markersOnScreen) {
                    markersOnScreen[id].remove();
                }
                markersOnScreen = {};
                return;
            }

            // Include vehicle by zoom
            // const vehicleLevels = [];
            // if (zoom >= zoomThreshold) {
            //     if (zoom < zoomThreshold + 1) vehicleLevels = ['plane'];
            //     else if (zoom < zoomThreshold + 1.5) vehicleLevels = ['car', 'plane'];
            //     else vehicleLevels = ['car', 'plane', 'boat'];
            // }

            // Include priority by zoom
            const priorityLevels = [];
            if (zoom >= zoomThreshold) {
                if (zoom < zoomThreshold + 1) priorityLevels.push('Q', 'P');
                else if (zoom < zoomThreshold + 1.5) priorityLevels.push('Q', 'P', 'T');
                else if (zoom < zoomThreshold + 2) priorityLevels.push('Q', 'P', 'T', 'D');
                else priorityLevels.push('Q', 'P', 'T', 'D', 'S');
            }

            const newMarkers = {};
            const features = map.querySourceFeatures('location');

            // Sort by latitude for z-index
            const sortedFeatures = features.sort((a, b) => {
                return b.geometry.coordinates[1] - a.geometry.coordinates[1];
            }).map((feature, index) => {
                feature.properties.zindex = index;
                return feature;
            });

            for (let i = 0; i < sortedFeatures.length; i++) {
                const coords = features[i].geometry.coordinates;
                const props = features[i].properties;

                // Apply the category filter based on the global selectedCategory
                if (currentActiveCategory !== 'all' && props.category !== currentActiveCategory) continue;

                // Exclude clusters and zoom-based priority levels (if not vehicle)
                if (!props.vehicle) {
                    if (props.cluster || !priorityLevels.includes(props.priority)) continue;
                }
                const id = props.id;

                let marker = markers[id];
                if (!marker) {
                    // Create container div
                    const el = document.createElement('div');
                    el.className = 'custom-marker';
                    el.dataset.id = id;
                    el.dataset.feature = JSON.stringify(features[i]);

                    // Create marker wrapper (holds circle + triangle)
                    const markerWrapper = document.createElement('div');
                    markerWrapper.className = 'custom-marker-wrapper';

                    if (props.vehicle) {
                        // vehicle marker
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'custom-vehicle-img-container';
                        imgContainer.style.border = `3px solid ${getCategoryColor(props.category)}`;

                        // Create image element
                        const img = document.createElement('img');
                        img.src = `${imgSource}/${props.img}.png`;
                        img.className = 'custom-vehicle-img';

                        // Build the structure
                        imgContainer.appendChild(img);
                        markerWrapper.appendChild(imgContainer);
                    } else {
                        // non-vehicle marker
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'custom-marker-img-container';
                        imgContainer.style.border = `3px solid ${getCategoryColor(props.category)}`;

                        // Create image element
                        const img = document.createElement('img');
                        img.src = `${imgSource}/${props.img}.png`;
                        img.className = 'custom-marker-img';

                        // Create triangle element
                        const triangle = document.createElement('div');
                        triangle.className = 'custom-marker-triangle';
                        triangle.style.borderTopColor = getCategoryColor(props.category);

                        // Build the structure
                        imgContainer.appendChild(img);
                        markerWrapper.appendChild(imgContainer);
                        markerWrapper.appendChild(triangle);
                    }

                    // Create star
                    if (['Q', 'P'].includes(props.priority)) {
                        const star = document.createElement('div');
                        star.className = 'custom-marker-star';
                        star.innerHTML = '<i class="fas fa-star"></i>';
                        star.style.color = getPriorityColor(props.priority);
                        markerWrapper.appendChild(star);
                    }

                    // Add all elements to wrapper
                    el.appendChild(markerWrapper);

                    // Create marker
                    marker = markers[id] = new maplibregl.Marker({
                        element: el,
                        anchor: props.vehicle ? 'center' : 'bottom',
                        offset: props.vehicle ? [0, 0] : [0, -7]
                    }).setLngLat(coords);
                }
                newMarkers[id] = marker;

                // Add z-index by latitude
                marker.getElement().style.zIndex = sortedFeatures.length + i;
                if (!markersOnScreen[id]) marker.addTo(map);
            }

            for (const id in markersOnScreen) {
                if (!newMarkers[id]) markersOnScreen[id].remove();
            }
            markersOnScreen = newMarkers;
        }

        const updateInfoBox = async () => {
            const features = map.querySourceFeatures('location');
            const infoBox = document.getElementById('info-box');
            const btn = document.getElementById('refresh-features-btn');

            let uniqueFeatures = new Map();

            infoBox.classList.add('visible');
            infoBoxOpen = true;

            if (btn) {
                btn.innerHTML = '<i class="fas fa-chevron-down"></i> Hide Info';
                btn.disabled = false;
            }

            // Store the current content of the infoBox
            const currentContent = infoBox.innerHTML;

            // Create content
            const innerContainer = document.createElement('div');
            innerContainer.className = 'info-box-inner';

            // Add forward/back buttons
            const backButton = document.createElement('div');
            backButton.id = 'info-box-back';
            backButton.innerHTML = '<i class="fas fa-arrow-left"></i>';

            const forwardButton = document.createElement('div');
            forwardButton.id = 'info-box-forward';
            forwardButton.innerHTML = '<i class="fas fa-arrow-right"></i>';

            innerContainer.appendChild(backButton);
            innerContainer.appendChild(forwardButton);

            // Scroll amounts (adjust as needed)
            const scrollAmount = 300;

            // Back button click handler
            backButton.addEventListener('click', () => {
                innerContainer.scrollBy({
                    left: -scrollAmount,
                    behavior: 'smooth'
                });
            });

            // Forward button click handler
            forwardButton.addEventListener('click', () => {
                innerContainer.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
            });

            // Process each feature
            for (const feature of features) {
                if (feature.properties.cluster_id) {
                    // Handle clustered features
                    const clusterId = feature.properties.cluster_id;

                    try {
                        // Get the individual features within the cluster
                        const clusterFeatures = await map.getSource('location').getClusterLeaves(
                            clusterId,
                            Infinity,
                            0
                        );
                        clusterFeatures.forEach(clusterFeature => {
                            const featureId = clusterFeature.properties.id;
                            if (!uniqueFeatures.has(featureId)) {
                                uniqueFeatures.set(featureId, clusterFeature);
                            }
                        });
                    } catch (error) {
                        console.error('Error fetching cluster leaves:', error);
                    }
                } else {
                    const featureId = feature.properties.id;
                    if (!uniqueFeatures.has(featureId)) {
                        uniqueFeatures.set(featureId, feature);
                    }
                }
            }

            // Convert the Map values to an array
            let allFeatures = Array.from(uniqueFeatures.values());

            // Sort features alphabetically by the 'mapname' property
            // allFeatures.sort((a, b) => {
            //     const nameA = a.properties.mapname || ''; // Changed from id to mapname for sorting
            //     const nameB = b.properties.mapname || '';
            //     return nameA.localeCompare(nameB);
            // });

            // Sort features by longitude (east to west)
            allFeatures.sort((a, b) => {
                const lonA = a.geometry.coordinates[0]; // Get longitude from first array element
                const lonB = b.geometry.coordinates[0];
                return lonA - lonB; // Sort from west (negative) to east (positive)
            });

            allFeatures.forEach(feature => {
                const properties = feature.properties;

                // Create feature container
                const featureElement = document.createElement('div');
                featureElement.className = 'info-feature';
                featureElement.dataset.id = properties.id;
                featureElement.dataset.feature = JSON.stringify(feature);
                //featureElement.style.border = `2px solid ${getCategoryColor(properties.category)}`;

                // Create popup-like structure
                const popupContent = document.createElement('div');
                popupContent.className = 'info-popup-content';

                // Create header section
                const popupHeader = document.createElement('div');
                popupHeader.className = 'info-popup-header';

                // Create banner and logo
                if (properties.img) {
                    const banner = document.createElement('img');
                    banner.src = `${imgSource}/${properties.category}_banner.png`;
                    banner.className = 'info-popup-banner';
                    //popupHeader.appendChild(banner);

                    // Create color overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'info-popup-banner-overlay';
                    overlay.style.backgroundColor = getCategoryColor(properties.category);
                    popupHeader.appendChild(overlay);

                    const img = document.createElement('img');
                    img.src = `${imgSource}/${properties.img}.png`;
                    img.className = 'info-popup-image';

                    // Make image clickable
                    img.addEventListener('click', (e) => {
                        e.stopPropagation();

                        // Get the feature data from the parent element
                        const featureData = JSON.parse(featureElement.dataset.feature);

                        // Fly to the feature's coordinates
                        flyToFeature(featureData.geometry.coordinates)
                            .then(() => {
                                // Find and activate the corresponding marker
                                const markerId = featureData.properties.id;
                                const markerElement = document.querySelector(`.custom-marker[data-id="${markerId}"]`);

                                if (markerElement) {
                                    markerElement.classList.add('active');
                                    setTimeout(() => {
                                        markerElement.classList.remove('active');
                                    }, 1500);
                                }

                                // Scroll to feature
                                scrollToFeatureInfo(featureData);
                            })
                            .catch(error => {
                                console.error('Fly to feature failed:', error);
                            });
                    });

                    popupHeader.appendChild(img);
                }

                // Create banner title
                // const title = document.createElement('h1');
                // title.className = 'info-popup-title';
                // title.textContent = properties.mapname;
                // popupHeader.appendChild(title);

                // Add header to content
                popupContent.appendChild(popupHeader);

                // Create text content container
                const textContainer = document.createElement('div');
                textContainer.className = 'info-popup-text';

                // Create title container
                const titleContainer = document.createElement('div');
                titleContainer.className = 'info-popup-title-container';

                // Create priority star if applicable
                if (properties.priority && ['Q', 'P'].includes(properties.priority)) {
                    const star = document.createElement('span');
                    star.className = 'info-popup-star';
                    star.innerHTML = '<i class="fas fa-star"></i>';
                    star.style.color = getPriorityColor(properties.priority);

                    // Insert star after map name
                    titleContainer.appendChild(star);
                }

                const mapname = document.createElement('h1');
                mapname.className = 'info-popup-mapname';
                mapname.textContent = properties.mapname;
                titleContainer.appendChild(mapname);

                textContainer.appendChild(titleContainer);

                // Add info text if exists
                if (properties.info) {
                    const infoText = document.createElement('p');
                    infoText.className = 'info-text';
                    infoText.textContent = properties.info;

                    // Add click to expand functionality
                    infoText.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.currentTarget.classList.toggle('expanded');
                    });

                    textContainer.appendChild(infoText);
                }

                // Create contact info container
                const contactInfo = document.createElement('div');
                contactInfo.className = 'contact-info';

                // Add Address if exists
                if (properties.address) {
                    const addressDiv = document.createElement('div');
                    addressDiv.className = 'contact-item';
                    addressDiv.innerHTML = `
                        <i class="fa-solid fa-location-dot"></i>
                        <a style="margin-left:4px;" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(properties.address_formatted)}" 
                        target="_blank">${properties.address_formatted}</a>
                    `;
                    contactInfo.appendChild(addressDiv);
                }

                // Add Phone if exists
                if (properties.phone) {
                    const phoneDiv = document.createElement('div');
                    phoneDiv.className = 'contact-item';
                    phoneDiv.innerHTML = `
                        <i class="fa-solid fa-phone"></i>
                        <a href="tel:${properties.phone}">${properties.phone}</a>
                    `;
                    contactInfo.appendChild(phoneDiv);
                }

                // Add Email if exists
                if (properties.email) {
                    const emailDiv = document.createElement('div');
                    emailDiv.className = 'contact-item';
                    emailDiv.innerHTML = `
                        <i class="fa-solid fa-envelope"></i>
                        <a href="mailto:${properties.email}">${properties.email}</a>
                    `;
                    contactInfo.appendChild(emailDiv);
                }

                // Add Website if exists
                if (properties.web) {
                    const webDiv = document.createElement('div');
                    webDiv.className = 'contact-item';
                    webDiv.innerHTML = `
                        <i class="fa-solid fa-globe"></i>
                        <a href="${properties.web}" target="_blank">${properties.web.replace(/^https?:\/\//, '')}</a>
                    `;
                    contactInfo.appendChild(webDiv);
                }

                // Add Facebook if exists
                if (properties.facebook) {
                    const fbDiv = document.createElement('div');
                    fbDiv.className = 'contact-item';
                    fbDiv.innerHTML = `
                        <i class="fa-brands fa-facebook"></i>
                        <a href="${properties.facebook}" target="_blank">${properties.facebook.replace(/^https?:\/\//, '')}</a>
                    `;
                    contactInfo.appendChild(fbDiv);
                }

                // Add Instagram if exists
                if (properties.instagram) {
                    const igDiv = document.createElement('div');
                    igDiv.className = 'contact-item';
                    igDiv.innerHTML = `
                        <i class="fa-brands fa-instagram"></i>
                        <a href="${properties.instagram}" target="_blank">${properties.instagram.replace(/^https?:\/\//, '')}</a>
                    `;
                    contactInfo.appendChild(igDiv);
                }

                // Add discount if exists
                if (properties.discount) {
                    const discountDiv = document.createElement('div');
                    discountDiv.className = 'contact-item';

                    // Create icon element
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-tag';

                    // Create text element
                    const text = document.createElement('p');
                    text.className = 'discount-text';
                    text.textContent = properties.discount + (properties.exp ? ` (${properties.exp})` : '');

                    // Add click handler to text
                    text.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.currentTarget.classList.toggle('expanded');
                    });

                    // Append elements
                    discountDiv.appendChild(icon);
                    discountDiv.appendChild(text);

                    contactInfo.appendChild(discountDiv);
                }

                // Add contact info
                if (contactInfo.children.length > 0) {
                    textContainer.appendChild(contactInfo);
                }

                // Add the complete text container to popup content
                popupContent.appendChild(textContainer);

                // Add the complete popup content to the feature element
                featureElement.appendChild(popupContent);
                innerContainer.appendChild(featureElement);
            });

            // Update DOM
            infoBox.innerHTML = '';
            infoBox.appendChild(innerContainer);
            if (innerContainer.children.length === 0 && currentContent) {
                infoBox.innerHTML = currentContent;
            }

            // Get center feature
            setupFeatureTracking();
        };

        // Close infobox on map click
        let clickOutsideHandler;

        function setupInfoBoxAutoClose() {
            // Remove previous handler if exists
            if (clickOutsideHandler) {
                document.removeEventListener('click', clickOutsideHandler);
            }

            clickOutsideHandler = (e) => {
                const infoBox = document.getElementById('info-box');
                const btn = document.getElementById('refresh-features-btn');

                if (!infoBox?.classList.contains('visible')) return;

                const protected = [
                    '.mapboxgl-marker',
                    '.custom-marker',
                    '#refresh-features-btn',
                    '#info-box',
                    '.maplibregl-popup' // Add if using popups
                ].join(',');

                if (!e.target.closest(protected)) {
                    infoBox.classList.remove('visible');
                    infoBoxOpen = false;

                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-chevron-up"></i> Show Info';
                        btn.disabled = false;
                    }
                }
            };

            document.addEventListener('click', clickOutsideHandler);
        }

        // Helper function to handle clicks
        const clickFeature = (feature) => {
            let coordinates = feature.geometry.coordinates;

            try {
                // Fly to location
                flyToFeature(coordinates);

                // Update infobox
                updateInfoBox();

                // Scroll to feature in infobox
                scrollToFeatureInfo(feature);
            } catch (error) {
                console.error('Error handling feature click:', error);
            }
        };

        // Helper function to fly to feature
        const flyToFeature = (coordinates) => {
            return new Promise((resolve) => {

                // Calculate dynamic offset based on viewport height
                const viewportHeight = window.innerHeight;
                const isMobile = window.innerWidth <= 768; // Common mobile breakpoint
                const offsetY = isMobile ? -viewportHeight * 0.15 : -80; // Adjust percentage as needed

                map.easeTo({
                    center: coordinates,
                    zoom: zoomThreshold + 3,
                    offset: [0, offsetY],
                    essential: true
                });

                map.once('moveend', resolve);
            });
        };

        // Helper function to scroll to feature info
        const scrollToFeatureInfo = (feature) => {
            const featureId = feature.properties.id;
            const infoFeature = document.querySelector(`.info-feature[data-id="${featureId}"]`);

            if (infoFeature) {
                // Scroll into view
                requestAnimationFrame(() => {
                    infoFeature.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',  // Better for horizontal scrolling
                        inline: 'center'
                    });
                });

                // Activate infobox feature
                if (infoFeature) {
                    infoFeature.classList.add('active');
                    setTimeout(() => infoFeature.classList.remove('active'), 1500);
                }
            }
        };

        // Helper function to get center infobox feature
        function handleCenterFeature() {
            const container = document.querySelector('.info-box-inner');
            if (!container) return;

            // Calculate center position
            const centerX = container.scrollLeft + (container.offsetWidth / 2);

            // Find centered feature
            const features = document.querySelectorAll('.info-feature');
            for (const feature of features) {
                const featureStart = feature.offsetLeft;
                const featureEnd = featureStart + feature.offsetWidth;

                if (featureStart <= centerX && featureEnd >= centerX) {
                    const featureData = JSON.parse(feature.dataset.feature);

                    flyToFeature(featureData.geometry.coordinates).then(() => {

                        // Find and activate the corresponding map marker
                        const markerId = featureData.properties.id;
                        const markerElement = document.querySelector(`.custom-marker[data-id="${markerId}"]`);
                        if (markerElement) {
                            markerElement.classList.add('active');
                            setTimeout(() => markerElement.classList.remove('active'), 1500);
                        }

                        // Find and activate infobox feature
                        const infoFeature = document.querySelector(`.info-feature[data-id="${markerId}"]`);
                        if (infoFeature) {
                            infoFeature.classList.add('active');
                            setTimeout(() => infoFeature.classList.remove('active'), 1500);
                        }

                    });
                    return featureData.properties.id;
                }
            }
        }

        // Helper function scroll listener
        let isUserScrolling = false;

        function setupFeatureTracking() {
            const container = document.querySelector('.info-box-inner');
            if (!container) return;

            // Detect ALL user scroll initiations (mouse, trackpad, touch, wheel)
            container.addEventListener('mousedown', () => isUserScrolling = true);
            container.addEventListener('touchstart', () => isUserScrolling = true);
            container.addEventListener('wheel', () => isUserScrolling = true, { passive: true });

            // Add keyboard scroll detection (NEW)
            document.addEventListener('keydown', (e) => {
                const scrollKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight',
                    'PageUp', 'PageDown', 'Home', 'End'];
                if (scrollKeys.includes(e.key)) {
                    isUserScrolling = true;
                }
            });

            // Handle scroll events
            container.addEventListener('scroll', () => {
                if (!isUserScrolling) return; // Ignore programmatic scrolls

                clearTimeout(window.scrollTimer);
                window.scrollTimer = setTimeout(() => {
                    handleCenterFeature(); // Your existing center-feature function
                    isUserScrolling = false; // Reset after scroll ends
                }, 150); // 150ms delay after scrolling stops
            });
        }

        const getCategoryColor = (category) => {
            const colorMap = {
                'eat_and_drink': 'hsl(35, 100%, 70%)',
                'visit_and_experience': 'hsl(0, 79%, 75%)',
                'learn_and_play': 'hsl(296, 30%, 68%)',
                'thrive_and_be_well': 'hsl(18, 55%, 63%)',
                'shop_and_discover': 'hsl(114, 35%, 61%)',
                'live_and_work': 'hsl(197, 35%, 66%)',
                'gather_and_connect': 'hsl(240, 12%, 54%)',
                'default': 'hsl(0, 0%, 100%)'
            };
            return colorMap[category] || colorMap.default;
        };

        const getPriorityColor = (priority) => {
            switch (priority) {
                case 'Q': return 'hsl(51, 100%, 50%)';
                case 'P': return 'hsl(51, 100%, 50%)';
                case 'T': return 'hsl(30, 100%, 50%)';
                case 'D': return 'hsl(240, 5%, 75%)';
                default: return 'hsl(0, 0%, 100%)';
            }
        }

        // Helper function: Haversine distance formula (in km)
        function getDistance(lngLat1, lngLat2) {
            const [lng1, lat1] = lngLat1;
            const [lng2, lat2] = lngLat2;

            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;

            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Update markers on the screen and do so on every map move/moveend
        map.on('data', (e) => {
            if (e.sourceId !== 'location' || !e.isSourceLoaded) return;

            map.on('move', updateMarkers);
            map.on('moveend', updateMarkers);
            updateMarkers();
        });

        // Update infobox in real time
        // map.on('data', (e) => {
        //     if (e.sourceId === 'location' && e.isSourceLoaded) {
        //         updateInfoBox();
        //     }
        // });

        // Forces depth re-calculation
        map.on('rotate', () => {
            map.triggerRepaint();
        });

        // Log clicks
        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point);
            if (features.length > 0) {
                console.log('Clicked feature:', features[0].properties);
            } else {
                console.log('No features at this location');
            }
        });

    </script>

</body>

</html>